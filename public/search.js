(()=>{"use strict";const e="https://api.themoviedb.org/3",t={Authorization:"Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIzODc3Y2NkZjhkNDFiMmMwNDAyYTQ2YjMzYTFmODU1NiIsIm5iZiI6MTc2NjUxODEzOS43OTMsInN1YiI6IjY5NGFlZDdiNTdkNDhkY2VmMWIxZDQzNSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.s7dVAKaihxDgIwKIEr3xcrCyabNxYLBHKMUNAO1ENEU","Content-Type":"application/json"};class s{static async getTrendingMovies(s=1){return(await fetch(`${e}/trending/movie/day?page=${s}`,{headers:t})).json()}static async searchMovies(s,o=1){return(await fetch(`${e}/search/movie?query=${encodeURIComponent(s)}&page=${o}`,{headers:t})).json()}static async getMovieDetails(s){return(await fetch(`${e}/movie/${s}`,{headers:t})).json()}static async getMovieReviews(s){const o=await fetch(`${e}/movie/${s}/reviews`,{headers:t});return(await o.json()).results||[]}static getImageUrl(e){return e?"https://image.tmdb.org/t/p/w500"+e:"https://via.placeholder.com/500x750?text=No+Image"}}const o="http://localhost:3001/api/auth";class n{static async createRequestToken(){const e=await fetch(`${o}/request-token`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json();if(t.request_token)return t.request_token;throw new Error("Failed to create request token")}static redirectToTMDBAuth(e){const t=`${window.location.origin}${window.location.pathname}`;window.location.href=`https://www.themoviedb.org/authenticate/${e}?redirect_to=${encodeURIComponent(t)}`}static async createSession(e){const t=await fetch(`${o}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_token:e})}),s=await t.json();if(s.sessionId){const e=s.sessionId;return localStorage.setItem(this.STORAGE_KEY,e),localStorage.setItem(this.USER_KEY,JSON.stringify(s.user)),e}throw new Error("Failed to create session")}static isAuthenticated(){return!!localStorage.getItem(this.STORAGE_KEY)}static getSessionId(){return localStorage.getItem(this.STORAGE_KEY)}static getUser(){const e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}static logout(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.USER_KEY)}static async addReview(e,t,s){const o=this.getSessionId();return!!o&&(await fetch(`http://localhost:3001/api/movie/${e}/rating`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:o,rating:t})})).ok}}n.STORAGE_KEY="tmdb_session",n.USER_KEY="tmdb_user";class i{static async getGeolocation(){if(this.cache)return this.cache;try{const e=await fetch("http://localhost:3001/api/proxy/geolocation");if(!e.ok)throw new Error("Failed to fetch geolocation");const t=await e.json();return this.cache=t,t}catch(e){return console.warn("Geolocation fetch failed:",e),null}}}i.cache=null,new class{constructor(){this.searchTimeout=null,this.currentPage=1,this.currentQuery="",this.results=[],this.totalPages=0,this.initializeAuth(),this.loadGeolocation(),this.setupEventListeners()}async loadGeolocation(){const e=await i.getGeolocation();e&&(window.appGeolocation=e)}initializeAuth(){const e=document.getElementById("loginBtn"),t=document.getElementById("logoutBtn");n.isAuthenticated()&&this.updateAuthUI(),e.addEventListener("click",()=>this.handleLogin()),t?.addEventListener("click",()=>this.handleLogout());const s=new URLSearchParams(window.location.search).get("request_token");s&&n.createSession(s).then(()=>{localStorage.setItem("auth_message","success"),window.location.href="search.html"}).catch(e=>{console.error("Failed to create session from redirect:",e),localStorage.setItem("auth_message","error"),window.location.href="search.html"});const o=localStorage.getItem("auth_message");o&&("success"===o?this.showSuccess("Connexion réussie."):this.showError("Échec de la connexion."),localStorage.removeItem("auth_message"))}showSuccess(e){const t=document.getElementById("success");t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}async handleLogin(){try{const e=await n.createRequestToken();n.redirectToTMDBAuth(e)}catch(e){console.error("Login error:",e),this.showError("Erreur lors de la connexion")}}handleLogout(){n.logout(),window.location.href="search.html"}updateAuthUI(){const e=document.getElementById("loginBtn"),t=document.getElementById("userInfo"),s=n.getUser();s&&(e.style.display="none",t.style.display="flex",document.getElementById("username").textContent=s.username,s.avatar&&(document.getElementById("userAvatar").src=s.avatar))}setupEventListeners(){const e=document.getElementById("searchInput"),t=document.getElementById("loadMoreBtn");e.addEventListener("input",e=>this.handleSearch(e)),t.addEventListener("click",()=>this.loadMoreResults()),window.addEventListener("scroll",()=>this.handleInfiniteScroll())}handleSearch(e){const t=e.target.value.trim();t.length<2?this.clearResults():(this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.currentQuery=t,this.currentPage=1,this.results=[],this.performSearch()},300))}async performSearch(){if(this.currentQuery)try{this.showLoading(!0);const e=await s.searchMovies(this.currentQuery,this.currentPage);this.results=e.results,this.totalPages=e.total_pages,0===this.results.length?this.showNoResults():(this.renderResults(),this.updateLoadMoreButton())}catch(e){console.error("Search error:",e),this.showError("Erreur lors de la recherche")}finally{this.showLoading(!1)}}async loadMoreResults(){if(this.currentQuery)try{this.showLoading(!0),this.currentPage++;const e=await s.searchMovies(this.currentQuery,this.currentPage);this.results=[...this.results,...e.results],this.renderResults(),this.updateLoadMoreButton()}catch(e){console.error("Load more error:",e),this.showError("Erreur lors du chargement de plus de résultats")}finally{this.showLoading(!1)}}handleInfiniteScroll(){window.innerHeight+window.scrollY>=document.documentElement.scrollHeight-500&&document.getElementById("loadMoreBtn").classList.contains("active")&&this.loadMoreResults()}renderResults(){const e=document.getElementById("resultsContainer"),t=document.getElementById("noResults");if(0===this.results.length)return e.innerHTML="",void(t.style.display="block");t.style.display="none",e.innerHTML=this.results.map(e=>`\n      <div class="movie-card">\n        <img src="${s.getImageUrl(e.poster_path)}" alt="${e.title}" class="movie-poster">\n        <div class="movie-info">\n          <div class="movie-title">${e.title}</div>\n          <button class="more-info-btn" onclick="window.location.href='movie.html?id=${e.id}'">\n            En savoir plus\n          </button>\n        </div>\n      </div>\n    `).join("")}updateLoadMoreButton(){const e=document.getElementById("loadMoreBtn");this.currentPage<this.totalPages?e.classList.add("active"):e.classList.remove("active")}clearResults(){const e=document.getElementById("resultsContainer"),t=document.getElementById("noResults"),s=document.getElementById("loadMoreBtn");e.innerHTML="",t.style.display="none",s.classList.remove("active"),this.results=[],this.currentPage=1}showNoResults(){const e=document.getElementById("resultsContainer"),t=document.getElementById("noResults"),s=document.getElementById("loadMoreBtn");e.innerHTML="",t.style.display="block",s.classList.remove("active")}showLoading(e){document.getElementById("loading").classList.toggle("active",e)}showError(e){const t=document.getElementById("error");t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}}})();
//# sourceMappingURL=search.js.map