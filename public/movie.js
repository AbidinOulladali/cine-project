(()=>{"use strict";const e="https://api.themoviedb.org/3",t={Authorization:"Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIzODc3Y2NkZjhkNDFiMmMwNDAyYTQ2YjMzYTFmODU1NiIsIm5iZiI6MTc2NjUxODEzOS43OTMsInN1YiI6IjY5NGFlZDdiNTdkNDhkY2VmMWIxZDQzNSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.s7dVAKaihxDgIwKIEr3xcrCyabNxYLBHKMUNAO1ENEU","Content-Type":"application/json"};class o{static async getTrendingMovies(o=1){return(await fetch(`${e}/trending/movie/day?page=${o}`,{headers:t})).json()}static async searchMovies(o,i=1){return(await fetch(`${e}/search/movie?query=${encodeURIComponent(o)}&page=${i}`,{headers:t})).json()}static async getMovieDetails(o){return(await fetch(`${e}/movie/${o}`,{headers:t})).json()}static async getMovieReviews(o){const i=await fetch(`${e}/movie/${o}/reviews`,{headers:t});return(await i.json()).results||[]}static getImageUrl(e){return e?"https://image.tmdb.org/t/p/w500"+e:"https://via.placeholder.com/500x750?text=No+Image"}}const i="http://localhost:3001/api/auth";class n{static async createRequestToken(){const e=await fetch(`${i}/request-token`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json();if(t.request_token)return t.request_token;throw new Error("Failed to create request token")}static redirectToTMDBAuth(e){const t=`${window.location.origin}${window.location.pathname}`;window.location.href=`https://www.themoviedb.org/authenticate/${e}?redirect_to=${encodeURIComponent(t)}`}static async createSession(e){const t=await fetch(`${i}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_token:e})}),o=await t.json();if(o.sessionId){const e=o.sessionId;return localStorage.setItem(this.STORAGE_KEY,e),localStorage.setItem(this.USER_KEY,JSON.stringify(o.user)),e}throw new Error("Failed to create session")}static isAuthenticated(){return!!localStorage.getItem(this.STORAGE_KEY)}static getSessionId(){return localStorage.getItem(this.STORAGE_KEY)}static getUser(){const e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}static logout(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.USER_KEY)}static async addReview(e,t,o){const i=this.getSessionId();return!!i&&(await fetch(`http://localhost:3001/api/movie/${e}/rating`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:i,rating:t})})).ok}}n.STORAGE_KEY="tmdb_session",n.USER_KEY="tmdb_user";class s{static async getGeolocation(){if(this.cache)return this.cache;try{const e=await fetch("http://localhost:3001/api/proxy/geolocation");if(!e.ok)throw new Error("Failed to fetch geolocation");const t=await e.json();return this.cache=t,t}catch(e){return console.warn("Geolocation fetch failed:",e),null}}}s.cache=null,new class{constructor(){this.movieId=null,this.movie=null,this.comments=[],this.selectedRating=0,this.movieId=this.getMovieIdFromURL(),this.movieId&&(this.initializeAuth(),this.loadGeolocation(),this.loadMovie(),this.loadComments())}async loadGeolocation(){const e=await s.getGeolocation();e&&(window.appGeolocation=e)}getMovieIdFromURL(){const e=new URLSearchParams(window.location.search).get("id");return e?parseInt(e,10):null}initializeAuth(){const e=document.getElementById("loginBtn"),t=document.getElementById("logoutBtn"),o=document.getElementById("loginLink");n.isAuthenticated()?(this.updateAuthUI(),this.setupReviewForm()):this.showLoginMessage(),e.addEventListener("click",()=>this.handleLogin()),t?.addEventListener("click",()=>this.handleLogout()),o?.addEventListener("click",e=>{e.preventDefault(),this.handleLogin()});const i=new URLSearchParams(window.location.search).get("request_token");i&&this.completeAuthentication(i)}async handleLogin(){try{const e=await n.createRequestToken();n.redirectToTMDBAuth(e)}catch(e){console.error("Login error:",e),this.showError("Erreur lors de la connexion")}}async completeAuthentication(e){try{await n.createSession(e),window.location.href=`movie.html?id=${this.movieId}`}catch(e){console.error("Authentication error:",e),this.showError("Erreur lors de la finalisation de la connexion")}}handleLogout(){n.logout(),window.location.href=`movie.html?id=${this.movieId}`}updateAuthUI(){const e=document.getElementById("loginBtn"),t=document.getElementById("userInfo"),o=n.getUser();o&&(e.style.display="none",t.style.display="flex",document.getElementById("username").textContent=o.username,o.avatar&&(document.getElementById("userAvatar").src=o.avatar))}showLoginMessage(){const e=document.getElementById("ratingSection"),t=document.getElementById("loginMessage"),o=document.getElementById("reviewForm");e.style.display="block",t.style.display="block",o.style.display="none"}setupReviewForm(){const e=document.getElementById("ratingSection"),t=document.getElementById("loginMessage"),o=document.getElementById("reviewForm"),i=document.getElementById("ratingStars");e.style.display="block",t.style.display="none",o.style.display="block";for(let e=1;e<=10;e++){const t=document.createElement("span");t.className="star",t.textContent="★",t.addEventListener("click",()=>this.setRating(e)),t.addEventListener("mouseover",()=>this.previewRating(e)),i.appendChild(t)}i.addEventListener("mouseleave",()=>this.previewRating(this.selectedRating)),o.addEventListener("submit",e=>this.handleReviewSubmit(e))}setRating(e){this.selectedRating=e,this.previewRating(e)}previewRating(e){document.querySelectorAll(".star").forEach((t,o)=>{o<e?t.classList.add("active"):t.classList.remove("active")})}async handleReviewSubmit(e){if(e.preventDefault(),0===this.selectedRating)return void this.showError("Veuillez sélectionner une note");const t=document.getElementById("reviewText").value;if(t.trim())try{if(!this.movieId)return;await n.addReview(this.movieId,this.selectedRating,t)?(this.showSuccess("Votre avis a été publié !"),document.getElementById("reviewForm").reset(),this.selectedRating=0,this.previewRating(0),setTimeout(()=>this.loadComments(),1e3)):this.showError("Erreur lors de la publication de l'avis")}catch(e){console.error("Review error:",e),this.showError("Erreur lors de la publication de l'avis")}else this.showError("Veuillez écrire un avis")}async loadMovie(){if(this.movieId)try{const e=document.getElementById("movieContent");e.style.display="none",this.movie=await o.getMovieDetails(this.movieId),this.renderMovie(),e.style.display="block"}catch(e){console.error("Error loading movie:",e),this.showError("Erreur lors du chargement du film")}finally{this.hideLoading()}}renderMovie(){this.movie&&(document.getElementById("title").textContent=this.movie.title,document.getElementById("poster").src=o.getImageUrl(this.movie.poster_path),document.getElementById("overview").textContent=this.movie.overview,document.getElementById("releaseDate").textContent=new Date(this.movie.release_date).toLocaleDateString("fr-FR"),document.getElementById("rating").textContent=`${(this.movie.vote_average||0).toFixed(1)}/10`)}async loadComments(){if(this.movieId)try{this.comments=await o.getMovieReviews(this.movieId),this.renderComments()}catch(e){console.error("Error loading comments:",e),this.showError("Erreur lors du chargement des avis")}}renderComments(){const e=document.getElementById("commentsContainer");0!==this.comments.length?e.innerHTML=this.comments.map(e=>`\n      <div class="comment">\n        <div class="comment-header">\n          ${e.author_details.avatar_path?`<img src="${e.author_details.avatar_path}" alt="${e.author_details.name}" class="comment-avatar">`:'<div class="comment-avatar"></div>'}\n          <div class="comment-info">\n            <div class="comment-author">${e.author_details.name||e.author}</div>\n            <div class="comment-date">${new Date(e.created_at).toLocaleDateString("fr-FR")}</div>\n          </div>\n        </div>\n        <div class="comment-content">${this.escapeHtml(e.content)}</div>\n      </div>\n    `).join(""):e.innerHTML='<div class="no-comments">Aucun avis pour le moment.</div>'}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}hideLoading(){document.getElementById("loading").style.display="none"}showError(e){const t=document.getElementById("error");t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}showSuccess(e){const t=document.getElementById("success");t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}}})();
//# sourceMappingURL=movie.js.map